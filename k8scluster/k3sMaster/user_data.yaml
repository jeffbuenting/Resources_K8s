#cloud-config

# https://computingforgeeks.com/install-kubernetes-on-ubuntu-using-k3s/
# https://kb.vmware.com/s/article/82250

# Upgrade the instance on first boot
package_update: true
package_upgrade: true

users:
  - default
  - name: jeff
    # plain_text_passwd: ${adminpassword}
    # this is the password hash generated by mkpasswd --method=SHA-512 --rounds=4096
    passwd: "${adminpassword}"
    sudo: ALL=(ALL) ALL
    groups: users, sudo
    lock_passwd: false
    ssh_authorized_keys:
      - ${ssh_rsa_key}

packages:
  - apt-transport-https 
  - ca-certificates 
  - curl 
  - software-properties-common


write_files:
  # set the cgroup driver for docker to match K3s
  # https://stackoverflow.com/questions/41627573/kubectl-get-nodes-not-showing-workers
  - path: /tmp/daemon.json
    content: | 
      {
        "exec-opts": ["native.cgroupdriver=cgroupfs"]
      }

runcmd:
  # Add Docker APT repository
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"

  # Install Docker CE
  - apt update
  - apt install docker-ce -y

  # move the docker config daemon.json from tmp to the correct location
  - mv /tmp/daemon.json /etc/docker/daemon.json

  # start and enable services
  - systemctl start docker
  - sudo systemctl enable docker

  # install K3s and start automatically
  - curl -sfL https://get.k3s.io | sh -s - server --cluster-init
  # --docker

  # allow K3s ports  thru firewall
  - ufw allow 6443/tcp
  - ufw allow 443/tcp

  # need to move these to a location that the worker tf files has access.
  - cp /var/lib/rancher/k3s/server/node-token /tmp/node-token
  - chmod 666 /tmp/node-token
  - cp /etc/rancher/k3s/k3s.yaml /tmp/k3s.yaml
  - chmod 666 /tmp/k3s.yaml

  
